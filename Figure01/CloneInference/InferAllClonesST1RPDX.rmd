---
title: "Test calling clonal cnvs in ST1RPDX"
output:
  html_document:
    df_print: paged
---
Here, we look at the results of running scAbsolute on this sample.


```{r}
library(ComplexHeatmap)
library(data.table)
library(QDNAseq)
library(RColorBrewer)
library(HMMcopy)
library(doParallel)
library(gtools)
library(ggplot2)


source("~/scAbsolute-main/R/visualization.R")
source("~/scAbsolute-main/R/mean-variance.R")
source("~/scAbsolute-main/R/scAbsolute.R")
source("~/scAbsolute-main/R/core.R")



source("~/MB_SCSEQ/Figure01/CloneInference/commonSegmentation.R")
source("~/MB_SCSEQ/Figure01/CloneInference/plotFunctionsCNV.R")
source("~/MB_SCSEQ/Figure01/CloneInference/inferClonalCNVProfiles.R")
source("~/MB_SCSEQ/Figure01/CloneInference/calculateBootstrappedStatistics.R")
```

## 10x data

Load in the results for all the STP samples here:

```{r}


ST1RPDX <- readRDS("~/groups/OE0585/internal/p163v/scAbsoluteWorkflow/results/scale/STPR-PDX/500/predict/out.rds")
protocolData(ST1RPDX) <- AnnotatedDataFrame()
colnames(ST1RPDX) <- gsub(colnames(ST1RPDX), pat = "\\-[0-9]\\.filtered\\.sorted$", rep = "")

# STPRNucres <- readRDS("~/groups/OE0585/internal/p163v/scAbsoluteWorkflow/results/scale/STPR-Nuclei//500/predict/out.rds")

# STPRNucres <- readRDS("~/groups/OE0585/internal/p163v/scAbsoluteWorkflow/results/scale/RCMB18-PDX/500/predict/out.rds")


# STPPDXres <- STPPDXres[,STPPDXres$ploidy.mod %in% seq(1,4)]
# STPRPDXres <- STPRPDXres[,STPRPDXres$ploidy.mod %in% seq(1,4)]
# ST1RPDX <- ST1RPDX[,ST1RPDX$ploidy.mod %in% seq(1,4)]
# STPRNucres <- STPRNucres[,STPRNucres$ploidy.mod %in% seq(1,4)]

```

## ST1RPDX clone identification

```{r}


hist(ST1RPDX$observed.variance/ST1RPDX$expected.variance, breaks = 50)
abline(v=mad(ST1RPDX$observed.variance/ST1RPDX$expected.variance)*2+median(ST1RPDX$observed.variance/ST1RPDX$expected.variance))
```

There are clear outliers based on variance, which we remove.

```{r}

hist(ST1RPDX$gini_normalized, breaks = 50)
abline(v=mad(ST1RPDX$gini_normalized)*2+median(ST1RPDX$gini_normalized))

```

```{r}

hist(ST1RPDX$error, breaks = 60)
abline(v=mad(ST1RPDX$error)*2+median(ST1RPDX$error))

```


```{r}

var.filter <- mad(ST1RPDX$observed.variance/ST1RPDX$expected.variance)*2+median(ST1RPDX$observed.variance/ST1RPDX$expected.variance) > ST1RPDX$observed.variance/ST1RPDX$expected.variance
gini.filter <- mad(ST1RPDX$gini_normalized)*2+median(ST1RPDX$gini_normalized) > ST1RPDX$gini_normalized
# error.filter <- mad(ST1RPDX$error)*2+median(ST1RPDX$error) > ST1RPDX$error
## Ploidy 0 doesn't work for ploidy normalization
ploidy.filter <- ST1RPDX$ploidy.mod > 0
ST1RPDX <- ST1RPDX[,var.filter&gini.filter&ploidy.filter]

```


Lets plot all the cell results for manual review:

```{r}

plotDataset(ST1RPDX, file="ST1R_PDX_scAbs_allcells.pdf", f=plotCopynumber)

```


```{r}
ST1RPDXSegmented <- mapCellsToCommonBreakpoints(ST1RPDX, mergeWidth = 2)

ploidy.data <- data.frame(chr="ploidy", "start"=-1, end=-1)
ploidy.data <- cbind(ploidy.data, t(data.frame(ST1RPDX$ploidy.mod)))

ST1RPDX.ploidy.normed <- copy(ST1RPDXSegmented)

for(cell in colnames(ST1RPDX)){
  
  ST1RPDX.ploidy.normed[,(cell):= ST1RPDX.ploidy.normed[,cell, with=F]/ ST1RPDX[,cell]$ploidy.mod*2]
}

ST1RPDX.ploidy.normed <- rbind(ST1RPDX.ploidy.normed, ploidy.data, use.names=F)


```

```{r}
dendroOrder <- rowSums(abs(t(assayDataElement(ST1RPDX, "copynumber"))-ST1RPDX$ploidy.mod), na.rm = TRUE)

annot_rows = rowAnnotation(ploidy=ST1RPDX$ploidy.mod, "obs/exp var"=ST1RPDX$observed.variance/ST1RPDX$expected.variance, "gini"=ST1RPDX$gini, error=ST1RPDX$error)


ploidy.normed.man.wardd2 <- hclust(dist(t(ST1RPDX.ploidy.normed[,c(-1,-2,-3)]), method="manhattan"), method = "ward.D2")

  
plotComplexHeatmapCommonSegs(ST1RPDXSegmented, clust.rows=ploidy.normed.man.wardd2, annot_rows=annot_rows, column_title = unique(ST1RPDXSegmented$chr))
  
```

```{r}

annot_rows = rowAnnotation(ploidy=ST1RPDX$ploidy.mod, "obs/exp var"=ST1RPDX$observed.variance/ST1RPDX$expected.variance, "gini"=ST1RPDX$gini, error=ST1RPDX$error)


bins.man.wardd2 <- clusterMannhattanOnBins(ST1RPDX)

denrToPlot <- reorder(as.dendrogram(bins.man.wardd2),dendroOrder)


# xx <- prcomp(t(ST1RPDXSegmented[complete.cases(ST1RPDXSegmented),c(-1,-2,-3), with=FALSE]))$x[,"PC1"]
# denrToPlot <- reorder(as.dendrogram(bins.man.wardd2),xx)

plotComplexHeatmapCommonSegs(ST1RPDXSegmented, clust.rows=denrToPlot, annot_rows=annot_rows)#, column_title = unique(featureData(ST1RPDX)$chromosome))
  
```

```{r}

annot_rows = rowAnnotation(ploidy=ST1RPDX$ploidy.mod, "obs/exp var"=ST1RPDX$observed.variance/ST1RPDX$expected.variance, "gini"=ST1RPDX$gini, error=ST1RPDX$error)


bins.cor.wardd2 <- clusterCorOnBins(ST1RPDX)

denrToPlot <- reorder(as.dendrogram(bins.cor.wardd2),dendroOrder)


# xx <- prcomp(t(ST1RPDXSegmented[complete.cases(ST1RPDXSegmented),c(-1,-2,-3), with=FALSE]))$x[,"PC1"]
# denrToPlot <- reorder(as.dendrogram(bins.man.wardd2),xx)

plotComplexHeatmapCommonSegs(ST1RPDXSegmented, clust.rows=denrToPlot, annot_rows=annot_rows)
  
```

# Read in HMMCopy
```{r}
set.seed(42)# set the seed of random number generator 

list.of.packages <- c("HMMcopy", "doParallel", "gtools", "ggplot2")


# ignore all "simple" diagnostic messages (warnings or errors)
suppressMessages(invisible(lapply(list.of.packages, require, character.only = TRUE)))


window_length <- 5e7
min_cnv_changes <- 10

nBootSamples <- 50
min_consec_cnvs <- 5

nthread <- 10
registerDoParallel(nthread)

```


##                       READ IN DATA OF INTEREST
############################################################################
```{r, warning=FALSE, message=FALSE}
## set sample of interest
sample = 'ST1R-PDX'



## bin size param
bin_kb = 20
bin = bin_kb*1000





# get the readcounts for the bin size of interest
path_cells <- paste0('/omics/groups/OE0540/internal/projects/chromothripsis_medulloblastoma/HMMcopy_10x_scDNA/all_samples/', 
                     sample,'/readCount_filtered_bam/bin_', bin_kb,'kb/')
path_to_readcounts <- paste0('/omics/groups/OE0540/internal/projects/chromothripsis_medulloblastoma/HMMcopy_10x_scDNA/all_samples/', 
                             sample,'/readCount_filtered_bam/bin_', bin_kb,'kb/')
files <- list.files(path_to_readcounts, pattern = '.seg', full.names = F)

# set the paths to the reference files
gfile = paste0('/omics/groups/OE0540/internal/projects/chromothripsis_medulloblastoma/HMMcopy_10x_scDNA/refdata/bin_', bin_kb, 'kb/hg19.', bin_kb, 'kb.gc.seg')
mfile =  paste0('/omics/groups/OE0540/internal/projects/chromothripsis_medulloblastoma/HMMcopy_10x_scDNA/refdata/bin_', bin_kb, 'kb/hg19.', bin_kb, 'kb.map.seg')



## Make list of cells
cellList <- list()

names(files) <- sapply(strsplit(files, split = "_|-"), `[[`, 3)

cellList <- foreach(cell = colnames(ST1RPDX)) %dopar% {
  print(paste0("Processing cell: ", cell))
  
  
  rfile <- paste(path_cells,files[[cell]],sep = "")
  cellData <- wigsToRangedData(rfile, gfile, mfile)
  
  correctReadcount2(cellData)

}
names(cellList) <- colnames(ST1RPDX)



```


```{r, results='hide'}
library(doParallel)
registerDoParallel(10)

# clonal.cnv.res.boot <- inferClonalCNVs(ST1RPDX, cellList, bootstrap = TRUE, nBoot=101)
# saveRDS(clonal.cnv.res.boot, file="st1r_pdx_boot_res.rds")

clonal.cnv.res.boot <- readRDS("st1r_pdx_boot_res.rds")

```


```{r}
for(ploidy in names(clonal.cnv.res.boot)){
  
  for(k in 1:12){
    pdf(paste0("ST1RPDX_",ploidy,"_k_", k, "clones_psuedobulk.pdf"), height = 11, width = 8.5)
    print(plotClonalProfilesAtK(clonal.cnv.res.boot[ploidy], k))
    dev.off()
  }
  
}



```



Lets plot some GOF metrics for the different k selections:

```{r}


clusterGOFmetrics <- computeGOFMetrics(clonal.cnv.res.boot)

#First ploidy 2:

ploidy2GOF <- sapply(clusterGOFmetrics$Ploidy_2, `[[`, 1)


pdf("ST1RPDX_ploidy2GOFbyK.pdf", onefile = TRUE)
plot(seq_len(ncol(ploidy2GOF)), ploidy2GOF["RMSE",], xlab="K", ylab="RMSE", type = "b", pch=16)
plot(seq_len(ncol(ploidy2GOF)), ploidy2GOF["logRMSE",], xlab="K", ylab="logRMSE", type = "b", pch=16)
plot(seq_len(ncol(ploidy2GOF)), ploidy2GOF["AIC",], xlab="K", ylab="AIC", type = "b", pch=16)
plot(seq_len(ncol(ploidy2GOF)), ploidy2GOF["BIC",], xlab="K", ylab="BIC", type = "b", pch=16)
dev.off()



```


```{r}

ploidy2.fstat <- sapply(clonal.cnv.res.boot$Ploidy_2, returnBootstrapFStats)

```


The F-Stat is suggesting that at k=4 we have the optimal clone definitions. 

Lets try to UMAP/t-SNE this to take a look at the data. 


```{r}
library(uwot)
library(ggplot2)

my.umap <- umap(dist(t(ST1RPDXSegmented[,-c(1:3), with=F])[ST1RPDX$ploidy.mod==2,]))

cluster_assignment <- rbindlist(lapply(clonal.cnv.res.boot$Ploidy_2$k_4, `[`, "cells"), idcol="Cluster")

toPlot <- data.frame(UMAP1 = my.umap[,1], UMAP2=my.umap[,2], Cluster=cluster_assignment$Cluster[match(rownames(my.umap), cluster_assignment$cells)])

ggplot(toPlot, aes(UMAP1, UMAP2, col=Cluster)) + geom_point()


```


```{r}

my.mds <- cmdscale(dist(t(ST1RPDXSegmented[,-c(1:3), with=F])[ST1RPDX$ploidy.mod==2,]))


toPlot <- data.frame(MDS1 = my.mds[,1], MDS2=my.mds[,2], Cluster=cluster_assignment$Cluster[match(rownames(my.mds), cluster_assignment$cells)])



ggplot(toPlot, aes(MDS1, MDS2, col=Cluster)) + geom_point()

```

```{r}
cluster_assignemntk2 <- rbindlist(lapply(clonal.cnv.res.boot$Ploidy_2$k_2, `[`, "cells"), idcol="Cluster")

toPlot <- data.frame(MDS1 = my.mds[,1], MDS2=my.mds[,2], Cluster=cluster_assignemntk2$Cluster[match(rownames(my.mds), cluster_assignemntk2$cells)])
ggplot(toPlot, aes(MDS1, MDS2, col=Cluster)) + geom_point()

```


```{r}
cluster_assignemntk3 <- rbindlist(lapply(clonal.cnv.res.boot$Ploidy_2$k_3, `[`, "cells"), idcol="Cluster")

toPlot <- data.frame(MDS1 = my.mds[,1], MDS2=my.mds[,2], Cluster=cluster_assignemntk3$Cluster[match(rownames(my.mds), cluster_assignemntk3$cells)])
ggplot(toPlot, aes(MDS1, MDS2, col=Cluster)) + geom_point()

```

Both solutions seem reasonable in this case. Lets take a look at what the profiles will look 
like for k=4 first. 


 
 
```{r}

clonalCNVProfiles <- clonal.cnv.res.boot$Ploidy_2$k_1$Cluster_1$pseudobulk[,c(1,2,3), with=FALSE]

ploidy2clones <- lapply(clonal.cnv.res.boot$Ploidy_2$k_3, function(k.res){
  return(round(2^(k.res$hmmres$mus[,1]+1)[k.res$hmmres$state]))
})

ploidy2clones <- do.call(cbind,ploidy2clones[as.logical(sapply(ploidy2clones, length))])
  
clonalCNVProfiles <- cbind(clonalCNVProfiles,ploidy2clones)

colnames(clonalCNVProfiles)[-c(1:3)] <- paste0("Clone_", 1:3) 

```



```{r}

saveRDS(clonalCNVProfiles, file="/omics/groups/OE0540/internal/projects/chromothripsis_medulloblastoma/scAbsolute_clones/ST1RPDX_draft_clonal_cnv.rds")
png("/omics/groups/OE0540/internal/projects/chromothripsis_medulloblastoma/scAbsolute_clones/ST1RPDX_clonal_cnv_draft.png", width=10, height=5, unit="in", res=1000)
print(plotComplexHeatmapCommonSegs(clonalCNVProfiles, clust.rows = FALSE, column_title = unique(clonalCNVProfiles$chr)))
dev.off()
```


Overall, K=4 looks like a resonable solution. Two of the clones look very similar on first 
glance, differing only in their chromothriptic region on 8, but it looks like there is also 
a gain on 16 that drives the difference as well. 

In the end, we end up choosing the k=3 solution in this case, as the differences between the two clones were too small. 


```{r}

ploidy2clonesCells <- lapply(clonal.cnv.res.boot$Ploidy_2$k_3, function(x) return(x['cells']))

ploidy2clonesCells <- ploidy2clonesCells[sapply(ploidy2clonesCells, function(x) length(x[[1]]))>=5]

allCloneCells <- ploidy2clonesCells

names(allCloneCells) <- paste0("Clone_", 1:3) 



cloneAssignment <- rbindlist(allCloneCells, idcol = "Clone")

if(any(!colnames(ST1RPDX)%in%cloneAssignment$cells)){
  notAssignedCells <- data.frame(Clone = "Not Assigned", cells=colnames(ST1RPDX)[!colnames(ST1RPDX)%in%cloneAssignment$cells])
  cloneAssignment <- rbind(cloneAssignment, notAssignedCells)
}



write.csv(cloneAssignment, file="~/groups/OE0540/internal/projects/chromothripsis_medulloblastoma/scAbsolute_clones/ST1R_PDX_cell_clone_assignments.csv")

```


```{r}

HMMCopyMat <- sapply(cellList, `[[`, "copy")

HMMCopyMat <- cbind(cellList[[1]][,c(1:3)], HMMCopyMat)

write.csv(HMMCopyMat, file="~/groups/OE0540/internal/projects/chromothripsis_medulloblastoma/scAbsolute_clones/ST1R_PDX_hmmcopy_20kb_logR.csv")


```


```{r}
library(dplyr)

gccor <- estimate_gc_correction(ST1RPDX)

scAbsoluteRC <- assayDataElement(ST1RPDX,"calls")*1/gccor

write.csv(scAbsoluteRC, file="~/groups/OE0540/internal/projects/chromothripsis_medulloblastoma/scAbsolute_clones/ST1R_PDX_scAbsolute_500kb_corReadCount.csv")

scAbsoluteTCN <- assayDataElement(ST1RPDX,"copynumber")
write.csv(scAbsoluteTCN, file="~/groups/OE0540/internal/projects/chromothripsis_medulloblastoma/scAbsolute_clones/ST1R_PDX_hmmcopy_500kb_TCN.csv")

```
